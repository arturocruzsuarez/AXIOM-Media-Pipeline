{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXIOM | Divergence Meter</title>
    <link href="https://fonts.googleapis.com/css2?family=Nixie+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'pipeline/css/dashboard.css' %}">
    <meta http-equiv="refresh" content="10">
</head>

<body>
    <div class="meter-container">
        <div class="status-label">Pipeline Stability Index (PSI)</div>

        <div id="divergence-meter" class="divergence-display {% if is_stable %}stable{% else %}unstable{% endif %}"
            data-target="{{ divergence_index }}">
            {{ divergence_index }}
        </div>

        <div class="status-label">
            Current State:
            <span class="{% if is_stable %}stable{% else %}unstable{% endif %}">
                {{ status }}
            </span>
        </div>

        <div class="world-line">
            {{ world_line }}
        </div>

        <div class="diagnostic-panel" style="margin-top: 40px; border-top: 1px solid #333; padding-top: 20px;">
            <div class="status-label"
                style="text-align: left; margin-bottom: 15px; color: var(--nixie-orange); font-size: 0.9em;">
                > System Hardware Diagnostic:
            </div>

            <table
                style="width: 100%; border-collapse: collapse; color: #eee; font-family: sans-serif; font-size: 0.85em;">
                <tr>
                    <td style="padding: 10px 5px; width: 100px;">DATABASE</td>
                    <td style="width: 60%;">
                        <div style="background: #222; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ health.database_score }}%; background: #00ff00; height: 100%;"></div>
                        </div>
                    </td>
                    <td style="padding: 0 10px; text-align: right;">{{ health.database_score|floatformat:1 }}%</td>
                    <td
                        style="color: {% if health.database_score > 90 %}#00ff00{% else %}#ff0000{% endif %}; font-weight: bold;">
                        {% if health.database_score > 90 %}NOMINAL{% else %}CRITICAL{% endif %}
                    </td>
                </tr>

                <tr>
                    <td style="padding: 10px 5px;">STORAGE</td>
                    <td>
                        <div style="background: #222; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ health.storage_score }}%; background: #00ccff; height: 100%;"></div>
                        </div>
                    </td>
                    <td style="padding: 0 10px; text-align: right;">{{ health.storage_score|floatformat:1 }}%</td>
                    <td
                        style="color: {% if health.storage_score > 10 %}#00ccff{% else %}#ffff00{% endif %}; font-weight: bold;">
                        {% if health.storage_score > 10 %}NOMINAL{% else %}LOW{% endif %}
                    </td>
                </tr>

                <tr>
                    <td style="padding: 10px 5px;">FFMPEG</td>
                    <td>
                        <div style="background: #222; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ health.ffmpeg_score }}%; background: #ff00ff; height: 100%;"></div>
                        </div>
                    </td>
                    <td style="padding: 0 10px; text-align: right;">{{ health.ffmpeg_score|floatformat:1 }}%</td>
                    <td
                        style="color: {% if health.ffmpeg_score > 0 %}#ff00ff{% else %}#ff0000{% endif %}; font-weight: bold;">
                        {% if health.ffmpeg_score > 0 %}READY{% else %}OFFLINE{% endif %}
                    </td>
                </tr>

                <tr>
                    <td style="padding: 10px 5px;">INTEGRITY</td>
                    <td>
                        <div style="background: #222; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div
                                style="width: {{ health.integrity_score }}%; background: var(--nixie-orange); height: 100%;">
                            </div>
                        </div>
                    </td>
                    <td style="padding: 0 10px; text-align: right;">{{ health.integrity_score|floatformat:1 }}%</td>
                    <td
                        style="color: {% if health.integrity_score > 95 %}var(--nixie-orange){% else %}#ffcc00{% endif %}; font-weight: bold;">
                        {% if health.integrity_score > 95 %}OPTIMAL{% else %}WARNING{% endif %}
                    </td>
                </tr>
            </table>

            <p style="font-size: 0.75em; color: #555; margin-top: 15px; text-align: right;">
                Last Heartbeat: {{ health.last_diagnostic|date:"H:i:s" }}
            </p>
        </div>
    </div>

    <footer>
        AXIOM Telemetry Engine v2.0 | Baseline: 0.132336 | El Psy Kongroo
    </footer>

    <script>
        window.onload = function () {
            const container = document.getElementById('divergence-meter');
            const targetValue = container.getAttribute('data-target').trim();
            const targetChars = targetValue.split('');
            container.innerHTML = '';

            const tubeElements = targetChars.map(char => {
                const tube = document.createElement('div');
                tube.className = 'nixie-tube';
                if (char === '.') {
                    tube.style.background = 'transparent';
                    tube.style.border = 'none';
                    tube.style.boxShadow = 'none';
                }
                const digit = document.createElement('div');
                digit.className = 'nixie-digit';
                digit.textContent = char;
                tube.appendChild(digit);
                container.appendChild(tube);
                return digit;
            });

            const duration = 2000;
            const startTime = Date.now();
            const interval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                tubeElements.forEach((digit, index) => {
                    if (targetChars[index] === '.') return;
                    if (progress < (index / targetChars.length)) {
                        digit.textContent = Math.floor(Math.random() * 10);
                    } else {
                        digit.textContent = targetChars[index];
                    }
                });

                if (progress >= 1) {
                    clearInterval(interval);
                    tubeElements.forEach((digit, index) => {
                        digit.textContent = targetChars[index];
                    });
                }
            }, 50);
        };
    </script>
</body>

</html>